<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <title>Responsive Dashboard</title>
  
</head>
<body>
  <div class="container">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="circle-group">
        <div class="circle red"></div>
        <div class="circle yellow"></div>
      </div>
      <div class="button-group">
        <button id="dashboardBtn" class="top-button">Dashboard</button>
        <button id="detailsBtn" class="top-button">Personal Details</button>
        <button id="billsBtn" class="top-button">Bills</button>
        <button class="logout-button" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- DASHBOARD Section -->
    <div id="dashboardSection" class="dashboard">
      <form class="notes" id="patientForm">
        <h2>Patient Notes</h2>
        <label>Name: <input type="text" id="name" required /></label>
        <label>Age: <input type="number" id="age" required /></label>
        <label>Gender:
          <select id="gender">
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </label>
        <label>Date: <input type="date" id="date" required /></label>
        <label>Reason for visit: <textarea id="reason" rows="2"></textarea></label>
        <label>Phone Number: <input type="tel" id="phone" required /></label>
        <button type="submit" class="pixel-button">Done</button>
      </form>

      <div class="queue-box">
        <h2>Current Queue</h2>
        <ul id="queueList"></ul>
      </div>
    </div>

    <!-- PERSONAL DETAILS Section -->
    <div id="detailsSection">
      <div class="searchbar">
        Enter Token Number:
        <input type="number" id="searchToken" />
        <button onclick="searchToken()">Search</button>
      </div>
      <div class="detailbox" id="detailResult">Token generated Details.</div>
    </div>
<!-- BILLS Section -->
<div id="billsSection" style="display: none;">
  <div class="bills-container">
    <!-- Token Input -->
    <div class="token-box">
      <h3>Choose Token Number</h3>
      <input type="text" id="billTokenInput" placeholder="Enter Token Number">
      <button onclick="generateBill()">Generate</button>
    </div>

    <!-- Bill + Prescription -->
    <div class="bill-prescription-boxes inner-scroll">
      <div class="bill-box">
        <h3>Bill Receipt</h3>
        <div id="billContent">Enter a valid token number to generate bill.</div>
      </div>

      <div class="prescription-box">
        <h3>Prescription</h3>
        <div id="prescriptionContent">Prescription will be shown here.</div>
      </div>
    </div>
  </div>
</div>



  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBHdkTLBvBozcLE1t5E5pNC06TMKVaMILw",
    authDomain: "clinic-abc01.firebaseapp.com",
    projectId: "clinic-abc01",
    storageBucket: "clinic-abc01.appspot.com",
    messagingSenderId: "543155713970",
    appId: "1:543155713970:web:5ce466e1e9685d197b16ab"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const form = document.getElementById("patientForm");
  const queueList = document.getElementById("queueList");

  // Get latest token for a given date
  async function getNextToken(date) {
    const snapshot = await db.collection("patients")
      .where("date", "==", date)
      .orderBy("token", "desc")
      .limit(1)
      .get();

    if (!snapshot.empty) {
      return snapshot.docs[0].data().token + 1;
    } else {
      return 1;
    }
  }

  async function renderQueue() {
    queueList.innerHTML = "";

    const today = new Date().toISOString().split("T")[0];

    const snapshot = await db.collection("patients")
      .where("date", "==", today)
      .orderBy("token")
      .get();

    snapshot.forEach(doc => {
      const entry = doc.data();
      const li = document.createElement("li");
      li.textContent = `Token No. ${entry.token} - ${entry.name}`;
      queueList.appendChild(li);
    });
  }
form.addEventListener("submit", async function (e) {
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const age = parseInt(document.getElementById("age").value);
  const gender = document.getElementById("gender").value;
  const date = document.getElementById("date").value;
  const reason = document.getElementById("reason").value.trim();
  const phone = document.getElementById("phone").value.trim();

  if (!name || !date || !phone) {
    alert("Please fill all required fields.");
    return;
  }

  try {
    const token = await getNextToken(date);

    const patient = {
      name,
      age,
      gender,
      date,
      reason,
      phone,
      token
    };

    await db.collection("patients").add(patient);
    alert("Patient successfully added.");
    form.reset();
    renderQueue();

  } catch (err) {
    console.error("Error adding patient:", err);
    alert("Failed to submit. Check console for errors.");
  }
});
window.addEventListener('error', function (e) {
  console.error('Global Error:', e.error);
});

  async function searchToken() {
    const searchVal = parseInt(document.getElementById("searchToken").value);
    const resultBox = document.getElementById("detailResult");

    if (!searchVal) {
      resultBox.innerHTML = "Please enter a valid token number.";
      return;
    }

   const snapshot = await db.collection("patients")
  .where("token", "==", searchVal)
  .get();


    if (!snapshot.empty) {
      const match = snapshot.docs[0].data();
      resultBox.innerHTML = `
        <strong>Token:</strong> ${match.token}<br/>
        <strong>Name:</strong> ${match.name}<br/>
        <strong>Age:</strong> ${match.age}<br/>
        <strong>Gender:</strong> ${match.gender}<br/>
        <strong>Date:</strong> ${match.date}<br/>
        <strong>Reason:</strong> ${match.reason}<br/>
        <strong>Phone:</strong> ${match.phone}
      `;
    } else {
      resultBox.innerHTML = "No patient found with this token number.";
    }
  }

  // Navigation
  const dashboardBtn = document.getElementById("dashboardBtn");
  const detailsBtn = document.getElementById("detailsBtn");
  const billsBtn = document.getElementById("billsBtn");

  const dashboardSection = document.getElementById("dashboardSection");
  const detailsSection = document.getElementById("detailsSection");
  const billsSection = document.getElementById("billsSection");

  dashboardBtn.addEventListener("click", () => {
    dashboardSection.style.display = "flex";
    detailsSection.style.display = "none";
    billsSection.style.display = "none";
  });

  detailsBtn.addEventListener("click", () => {
    dashboardSection.style.display = "none";
    detailsSection.style.display = "flex";
    billsSection.style.display = "none";
  });

  billsBtn.addEventListener("click", () => {
    dashboardSection.style.display = "none";
    detailsSection.style.display = "none";
    billsSection.style.display = "flex";
  });

async function generateBill() {
  const tokenNumber = parseInt(document.getElementById("billTokenInput").value.trim());
  if (!tokenNumber) {
    alert("Please enter a valid token number.");
    return;
  }

  try {
    const snapshot = await db.collection("patients")
      .where("token", "==", tokenNumber)
      .limit(1)
      .get();

    if (snapshot.empty) {
      document.getElementById("billContent").innerText = "No patient found with this token.";
      document.getElementById("prescriptionContent").innerText = "";
      return;
    }

    const patientData = snapshot.docs[0].data();
    const billHtml = `
      <p><strong>Patient Name:</strong> ${patientData.name}</p>
      <p><strong>Age:</strong> ${patientData.age}</p>
      <p><strong>Date:</strong> ${patientData.date}</p>
      <p><strong>Token Number:</strong> ${patientData.token}</p>
      <p><strong>Consultation Fee:</strong> â‚¹500</p>
      <p><strong>Status:</strong> Paid</p>
    `;
    document.getElementById("billContent").innerHTML = billHtml;

    // Fetch prescription from within the patient document
    const prescriptionData = patientData.prescription;

    if (prescriptionData) {
     document.getElementById("prescriptionContent").innerHTML = `
  <pre>${prescriptionData}</pre>
`;

    } else {
      document.getElementById("prescriptionContent").innerText = "No prescription found for this token.";
    }

  } catch (error) {
    console.error("Error generating bill or fetching prescription:", error);
    document.getElementById("billContent").innerText = "Failed to generate bill.";
    document.getElementById("prescriptionContent").innerText = "Error fetching prescription.";
  }
}

  function logout() {
  alert("Logged out.");
  window.location.href = "index.html"; // Redirect to index.html
}


  renderQueue();

</script>

</body>
</html>
